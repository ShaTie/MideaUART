```
███╗   ███╗██╗██████╗ ███████╗ █████╗ ██╗   ██╗ █████╗ ██████╗ ████████╗
████╗ ████║██║██╔══██╗██╔════╝██╔══██╗██║   ██║██╔══██╗██╔══██╗╚══██╔══╝
██╔████╔██║██║██║  ██║█████╗  ███████║██║   ██║███████║██████╔╝   ██║
██║╚██╔╝██║██║██║  ██║██╔══╝  ██╔══██║██║   ██║██╔══██║██╔══██╗   ██║
██║ ╚═╝ ██║██║██████╔╝███████╗██║  ██║╚██████╔╝██║  ██║██║  ██║   ██║
╚═╝     ╚═╝╚═╝╚═════╝ ╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝
```

ПАРАМЕТРЫ UART : `9600 8N1`

## Общие сведения

Управление домашними устройствами осуществляется с помощью небольших универсальных шлюзов, выполненных на SoC, имеющей как интерфейс UART для непосредственного обмена данными с устройством, так и сетевой, например, Wi-Fi для взаимодействия с внешними системами.

Шлюз имеет собственный унифицированный протокол взаимодействия по UART и требует обязательной частичной реализации некоторых функций на стороне устройств. Специализированное же управление обеспечивается *"прозрачными"* пакетами *"облако <-> шлюз <-> устройство"*, содержащими внутри себя пользовательский протокол, например, Midea. Данные внутри таких пакетов передаются устройству *"как есть"* без какой-либо обработки со стороны шлюза.

Шлюз поддерживает **два вида обмена** : *непрерывное (поточное)* и *по межкадровому интервалу*. В конкретном случае зависит от реализации конечного устройства производителем оборудования и определяется программно в процессе инициализации. Midea в своих устройствах использует последний вариант. В любом случае взаимодействие осуществляется сообщениями (кадрами) строго определенной структуры, которая описана ниже.

### Структура сообщения шлюза

| Позиция |            **Поле**             | **Длина** | Описание                                                                                                                                                                                                                                                                                                                             |
| :-----: | :-----------------------------: | :-------: | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|    0    |         Стартовый байт          |     1     | Признак начала сообщения. Всегда `0xAA`.                                                                                                                                                                                                                                                                                             |
|    1    |              Длина              |     1     | Длина сообщения без учета стартового байта, равна N+10 байт. Максимальная **полная длина** - 256.                                                                                                                                                                                                                                    |
|    2    | Идентификатор класса устройства |     1     | Класс устройства производителя. Значение `0xFF` широковещательное, зарезервировано для устройств любого класса, используется в процессе инициализации.                                                                                                                                                                               |
|    3    |     Проверка синхронизации      |     1     | "Исключающее ИЛИ" предыдущих полей: длины и идентификатора класса. Требуется во всех случаях, кроме входящих сообщений от устройств в режиме передачи по межкадровому интервалу. Подробная информация в описании инициализации.                                                                                                      |
|  4, 5   |             Резерв              |     2     | Всегда `0x00`.                                                                                                                                                                                                                                                                                                                       |
|    6    |          Идентификатор          |     1     | Идентификатор сообщения. Требуется во всех исходящих сообщениях, а также для соответствий запроса и ответа в потоковом режиме передачи. Во входящих сообщениях от устройств в режиме передачи по межкадровому интервалу всегда равен нулю, во всех остальных случаях отличен от нуля. Подробная информация в описании инициализации. |
|    7    |             Резерв              |     1     | Всегда `0x00`.                                                                                                                                                                                                                                                                                                                       |
|    8    |   Версия протокола устройства   |     1     | Версия протокола конечного устройства.                                                                                                                                                                                                                                                                                               |
|    9    |       Идентификатор типа        |     1     | Тип сообщения. Определяет формат данных. Запрос и ответ содержат одинаковые значения.                                                                                                                                                                                                                                                |
| 10 ...  |             Данные              |     N     | Полезные данные. Максимальный размер 245 байт.                                                                                                                                                                                                                                                                                       |
|  10+N   |        Контрольная сумма        |     1     | Дополнительный код (отрицание) суммы предыдущих полей сообщения, начиная с длины, то есть своим значением контрольная сумма должна дополнять результат до нуля.                                                                                                                                                                      |
#### Типы сообщений

| **Идентификатор** | **Наименование**                                     | **Инициатор** | Прозрачный | Обязательный к реализации устройством |
| ----------------- | ---------------------------------------------------- | ------------- | :--------: | :-----------------------------------: |
| `0x02`            | Управление устройством                               | Приложение    |    [x]     |                  [x]                  |
| `0x03`            | Опрос устройства                                     | Приложение    |    [x]     |                  [x]                  |
| `0x04`            | Уведомление о статусе устройства (не требует ответа) | Устройство    |    [x]     |                  [x]                  |
| `0x05`            | Уведомление о статусе устройства (требует ответ)     | Устройство    |    [x]     |                  [x]                  |
| `0x06`            | Уведомление о ошибке устройства (не требует ответа)  | Устройство    |    [x]     |                                       |
| `0x07`            | Чтение электронного идентификатора устройства        | Шлюз          |            |                  [x]                  |
| `0x0A`            | Уведомление о ошибке устройства (требует ответ)      | Устройство    |    [x]     |                                       |
| `0x0D`            | Уведомление о сетевом статусе и уровне сигнала       | Шлюз          |            |                                       |
| `0x11`            | Запись электронного идентификатора                   | Приложение    |            |                                       |
| `0x12`            | Смена SSID в режиме точки доступа                    | Устройство    |            |                                       |
| `0x13`            | MAC адрес                                            | Устройство    |            |                                       |
| `0x61`            | Калибровка времени                                   | Устройство    |    [x]     |                                       |
| `0x63`            | Сетевой статус и уровень сигнала                     | Устройство    |            |                                       |
| `0x68`            | Включение / отключение Wi-Fi                         | Устройство    |            |                                       |
| `0x6A`            | Смена конфигурации Wi-Fi                             | Устройство    |            |                                       |
| `0x6B`            | Список ближайших точек доступа                       | Устройство    |            |                                       |
| `0x81`            | Смена режима работы Wi-Fi (клиент или точка доступа) | Устройство    |            |                                       |
| `0x82`            | Перезагрузка                                         | Устройство    |            |                                       |
| `0x83`            | Сброс к заводским настройкам                         | Устройство    |            |                  [x]                  |
| `0xA0`            | Запрос модели и базовой информации об устройстве     | Приложение    |    [x]     |                  [x]                  |
#### Сообщения от устройства к шлюзу
##### `0x04` - Уведомление о статусе (не требует ответ)
Используется для **прозрачной** передачи статуса о работе устройства приложению. Не требует ответа.
##### `0x05` - Уведомление о статусе (требует ответ)
Используется для **прозрачной** передачи статуса о работе устройства приложению. Требует ответа.
##### `0x06` - Уведомление о ошибке (не требует ответ)
Используется для **прозрачной** передачи статуса о ошибке устройства приложению. Не требует ответа.
##### `0x0A` - Уведомление о ошибке (требует ответ)
Используется для **прозрачной** передачи статуса о ошибке устройства приложению. Требует ответа.
##### `0x12` - Смена SSID в режиме точки доступа
Смена устройством имени SSID шлюза, находящегося в режиме точки доступа. Данные запроса представляют собой типичную Pascal строку с максимальной длиной 32 символа.

Запрос :

| Байт | Описание                   |
| ---- | -------------------------- |
| 0    | Длина имени SSID (N <= 32) |
| 1-N  | Имя SSID                   |

Ответ :

| Байт | Описание                    |
| ---- | --------------------------- |
| 0    | 0 : Успешно; иное - ошибка. |
##### `0x13` - Чтение MAC адреса шлюза
Чтение устройством MAC адреса шлюза.

Запрос :

| Байт | Описание               |
| ---- | ---------------------- |
| 0    | Резерв. Всегда `0x00`. |

Ответ :

| Байт | Описание                           |
| ---- | ---------------------------------- |
| 0-5  | MAC адрес в Little-Endian формате. |

##### `0x61` - Калибровка времени
Запрос устройством текущие дату и время.

Запрос :

| Байт | Описание               |
| ---- | ---------------------- |
| 0-19 | Резерв. Всегда `0x00`. |

Ответ :

| Байт | Описание                           |
| ---- | ---------------------------------- |
| 0    | Секунды (0-59)                     |
| 1    | Минуты (0-59)                      |
| 2    | Часы (0-23)                        |
| 3    | День недели (0-6, 0 : воскресенье) |
| 4    | День (1-31)                        |
| 5    | Месяц (1-12)                       |
| 6    | Год (00-99)                        |
| 7    | Временная зона                     |
| 8-19 | Резерв. Всегда `0x00`.             |

##### `0x63` - Сетевой статус и уровень сигнала
Запрос устройством текущего сетевого статуса и уровня сигнала шлюза.

Запрос :

| Байт | Описание               |
| ---- | ---------------------- |
| 0-19 | Резерв. Всегда `0x00`. |

Ответ :

| Байт  | Описание                                                                                                                                                                      |
| ----- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0     | Тип модуля (0 : RF, 1 : Wi-Fi)                                                                                                                                                |
| 1     | Режим Wi-Fi (1 : клиент, 2 : конфигурация, 3 : точка доступа)                                                                                                                 |
| 2     | Уровень сигнала Wi-Fi (0 : отсутствует, 1-4 : уровни, 255 : Wi-Fi не поддерживается)                                                                                          |
| 3-6   | IP-адрес Wi-Fi                                                                                                                                                                |
| 7     | Уровень сигнала RF (0 : отсутствует, 1-4 : уровни, 5 : не регистрируется, 255 : RF не поддерживается)                                                                         |
| 8     | Статус сети (0 : подключен, 1 : не подключен, 2 : подключение, 3 : неверный пароль, 4 : не найдена сеть, 5 : не получен IP, 6 : сеть нестабильна, 255 : сбой оборудования)    |
| 9     | Статус облачного сервиса (0 : подключен, 1 : не подключен, 2 : нестабильный Интернет, 3 : сбой DNS, 4 : соединение отклонено, 5 : сервис на обслуживании, 255 : сбой сервиса) |
| 10    | Локальное подключение (0 : не установлено, 1 : установлено)                                                                                                                   |
| 11    | Количество локальных подключений                                                                                                                                              |
| 12-19 | Резерв. Всегда `0x00`.                                                                                                                                                        |



### Порядок инициализации
1. Приостановка выполнения на 3 секунды с момента подачи питания с целью гарантированного завершения инициализации подсистемы обмена данными конечного устройства ;
2. Определение способа обмена данными, типа устройства и версии протокола :
	1. Отправка сообщения `GET_ELECTRONIC_ID (0x07)` с общим классом устройства `0xFF` и идентификатором сообщения отличным от нуля ;
	2. Если идентификатор сообщения ответа нуль - требуется передача по межкадровому интервалу, если совпадает с идентификатором запроса - требуется передача поточного типа, иное значение не допустимо ;
	3. Из заголовка ответа взять тип устройства и версию протокола ;
	4. Использовать полученные данные в коммуникации с устройством .

РЕЖИМ ОБМЕНА по МЕЖКАДРОВОМУ ИНТЕРВАЛУ (используется Midea) :

1. ИСХОДЯЩИЙ пакет:

1.1. Установить байт синхронизации кадра;
1.2. Установить идентификатор кадра отличным от нуля;
1.3. Передача сообщений в виде очереди, блокирующей отправку на время ожидания
    ответа с таймаутом 1 сек.;
1.4. После ответа обеспечить межкадровый интервал >= 50 мс.;

2. ВХОДЯЩИЙ пакет:

2.1. Игнорировать байт синхронизации кадра;
2.2. Убедиться, что идентификатор кадра равен нулю;
2.3. Межкадровый интервал не регламентирован;

ПОТОКОВЫЙ РЕЖИМ ОБМЕНА (не используется Midea, не реализован) :

1. ИСХОДЯЩИЙ пакет:

1.1. Установить байт синхронизации кадра;
1.2. Установить идентификатор кадра отличным от нуля и последнего идентификатора;
1.3. Передача сообщений параллельна. Таймаут 5 сек. Во время ожидания ответа
    допускается отправка новых сообщений;
1.4. Межкадровый интервал не регламентирован;

2. ВХОДЯЩИЙ пакет:

2.1. Проверить целостность байта синхронизации кадра;
2.2. Убедиться, что идентификатор кадра не равен нулю. При необходимости, выполнить
    соответствие ответа запросу по равенству идентификаторов;
2.3. Межкадровый интервал не регламентирован;

